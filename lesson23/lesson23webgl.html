<!DOCTYPE html>
<html>
	<head>
		<title>NeHe - Lesson 23 - Spherical Mapping</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">

		<!-- The following meta line optimizes the site for mobile devices. It sets the viewport size
		to the screen size, so it will be displayed maximized, but unscaled. -->
		<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="../css/NEHE.css" />

		<!-- Include the necessary libs -->
		<script src="../js/three-75.js" type="text/javascript"></script>
		<script src="../js/Detector.js" type="text/javascript"></script>
        <script src="../js/OrbitControls-Touch.js" type="text/javascript"></script>
        <script src="../js/Stats.js" type="text/javascript"></script>
        <script src="../js/gfx-scene.js" type="text/javascript"></script>

	</head>
	<body>
    <!-- Create a DIV element, which will be shown over the WebGL canvas. The last line
    ("Renderer: ") will be completed either by "WebGL Renderer" or by "Canvas Renderer". -->
    <div id="overlaytext" style="position: absolute; top: 10px; left: 10px">
        'b' turn bump mapping on/off
        't' swap textures
    </div>
		<script type="text/javascript">
            var FLOOR_REPEAT = 5;
            // the global var (ick!) for the cube's mesh
            var mirrorSphereCamera;
            var mirrorSphere;

            // allocate the Scene object, and set the camera position
            var gfxScene = new GFX.Scene( { cameraPos : [3, 5, 10],
                                            controls : true,
											axesHeight:10,
                                            floorRepeat : FLOOR_REPEAT,
                                            displayStats:true});

			// Initialize the demo
			initializeDemo();

			// Animate the scene
			animateScene();

			/**
			 *  Initialize the demo's local aspects, i.e not the scene.
			 */
			function initializeDemo() {

                var sphereGeom =  new THREE.SphereGeometry( 2, 32, 32 ); // radius, segmentsWidth, segmentsHeight
                mirrorSphereCamera = new THREE.CubeCamera( 0.1, 5000, 512 );
                gfxScene.add( mirrorSphereCamera );

                var mirrorSphereMaterial = new THREE.MeshBasicMaterial( { envMap: mirrorSphereCamera.renderTarget, reflectivity:0.8 } );
                mirrorSphere = new THREE.Mesh( sphereGeom, mirrorSphereMaterial );
                mirrorSphere.position.set(0, 2, 0);
                mirrorSphereCamera.position.copy(mirrorSphere.position);
                gfxScene.add(mirrorSphere)

                // Add a listener for 'keydown' events. There's another event type: 'keypress',
                // but it will report only the visible characters like 'a', but not the function keys
                // like 'cursor up'.
                document.addEventListener("keydown", onDocumentKeyDown, false);
			}

            /**
             * This function is called, when a key is pushed down.
             */
            function onDocumentKeyDown(event){

                var keyChar = String.fromCharCode(event.which);
                keyChar = keyChar.toLowerCase();

                if (keyChar == 'b') {
                    bumped = !bumped;
                }
                else if (keyChar == 't') {
                    if ( image.indexOf('f') != -1)
                        image = "stone";
                    else
                        image = "flower";
                }

                makeMesh(bumped, image);
            }
			/**
			 * Animate the scene and call rendering.
			 */
			function animateScene() {

				// Tell the browser to call this function back
				requestAnimationFrame(animateScene);

                mirrorSphere.visible = false;
                mirrorSphereCamera.updateCubeMap( gfxScene.renderer, gfxScene.scene );
                mirrorSphere.visible = true;

                // Map the 3D scene down to the 2D screen (render the frame)
                gfxScene.renderScene();
			}

		</script>
	</body>
</html>
