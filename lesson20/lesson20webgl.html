<!DOCTYPE html>
<html>
	<head>
		<title>NeHe - Lesson 20 - Masks</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">

		<!-- The following meta line optimizes the site for mobile devices. It sets the viewport size
		to the screen size, so it will be displayed maximized, but unscaled. -->
		<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="../css/NEHE.css" />

		<!-- Include the necessary libs -->
		<script src="../js/three.js" type="text/javascript"></script>
		<script src="../js/Detector.js" type="text/javascript"></script>
        <script src="../js/OrbitControls-Touch.js" type="text/javascript"></script>
        <script src="../js/Stats.js" type="text/javascript"></script>
        <script src="../js/gfx-scene.js" type="text/javascript"></script>

		<!-- the shaders -->
		<script id="fragment_shader" type="x-shader/x-fragment">
            #ifdef GL_ES
            precision highp float;
            #endif

            uniform sampler2D tOne;
            uniform sampler2D tSec;

            varying vec2 vUv;

            void main(void)
            {
                vec3 c;
                vec4 Ca = texture2D(tOne, vUv);
                vec4 Cb = texture2D(tSec, vUv);
                /* c = Ca.rgb * Ca.a + Cb.rgb * Cb.a * (1.0 - Ca.a); */
                c = Ca.rgb * Ca.a + Cb.rgb * Cb.a * Ca.a;
                gl_FragColor= vec4(c, 1.0);

            }

        </script>

		<script id="vertex_shader" type="x-shader/x-vertex">

            varying vec2 vUv;

            void main()
            {
                vUv = uv;
                vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
                gl_Position = projectionMatrix * mvPosition;
            }

        </script>

	</head>
	<body>

		<script type="text/javascript">

            // allocate the Scene object, and set the camera position
            var gfxScene = new GFX.Scene( { cameraPos : [5,7.5,20],
                                            controls : true,
											axesHeight:10,
                                            displayStats:true});

			// Initialize the demo
			initializeDemo();

			// Animate the scene
			animateScene();

			/**
			 *  Initialize the demo's local aspects, i.e not the scene.
			 */
			function initializeDemo() {
                //var shaderMaterial = createShaderMaterial();

                var geom = new THREE.CubeGeometry( 2, 2, 2 );

                var texture = new THREE.ImageUtils.loadTexture("grass.jpg");
                var mask = new THREE.ImageUtils.loadTexture("Alpha-Map.png");

                var material = new THREE.MeshBasicMaterial( { map:texture, alphaMap:mask, side:THREE.DoubleSide, transparent:true } );
                //material.transparent = true;

                var mesh = new THREE.Mesh( geom, material );
                mesh.doubleSided = true;
                gfxScene.add(mesh);

			}

			function createShaderMaterial() {

                var vertShader = document.getElementById('vertex_shader').innerHTML;

                var fragShader = document.getElementById('fragment_shader').innerHTML;

                var attributes = {};

                //var tex1 = THREE.ImageUtils.loadTexture("grass.jpg", {}, function() { renderer.render(scene, camera);});
                //var tex2 = THREE.ImageUtils.loadTexture("frog.png", {}, function() { renderer.render(scene, camera);});

                var uniforms = {

                    tOne: { type: "t", value: THREE.ImageUtils.loadTexture( "wow.png" ) },
                    tSec: { type: "t", value: THREE.ImageUtils.loadTexture( "grass.jpg" ) }

                };

                var material_shader = new THREE.ShaderMaterial({
                    uniforms: uniforms,
                    attributes: attributes,
                    vertexShader: vertShader,
                    fragmentShader: fragShader
                });

                return material_shader;
            }

			/**
			 * Animate the scene and call rendering.
			 */
			function animateScene() {

				// Tell the browser to call this function back
				requestAnimationFrame(animateScene);

                // Map the 3D scene down to the 2D screen (render the frame)
                gfxScene.renderScene();
			}

		</script>
	</body>
</html>
