<!DOCTYPE html>
<html lang="en">
<head>
    <title>NEHE Lesson 36</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1"/>

    <script src="../js/three.js" type="text/javascript"></script>
    <script src="../js/shaders/CopyShader.js" type="text/javascript"></script>
    <script src="../js/shaders/AdditiveBlendShader.js"></script>    
    <script src="../js/shaders/HorizontalBlurShader.js"></script>
    <script src="../js/shaders/VerticalBlurShader.js"></script>
    <script src="../js/postprocess/EffectComposer.js" type="text/javascript"></script>
    <script src="../js/postprocess/ShaderPass.js" type="text/javascript"></script>
    <script src="../js/postprocess/RenderPass.js" type="text/javascript"></script>
    <script src="../js/postprocess/MaskPass.js" type="text/javascript"></script>
</head>
<body>
<script>
    var blurComposer, finalComposer;

    // then initialize our demo's stuff
    initializeDemo();

    // Animate the scene
    animateScene();

    /**
     * Initialize the Demo.
     */
    function initializeDemo() {
        var scene = new THREE.Scene();

        var camera = new THREE.PerspectiveCamera( 45, window.innerWidth/window.innerHeight, 0.1, 10000);
        scene.add(camera);
        camera.position.set(10,10,20);
        camera.lookAt(scene.position);

        var renderer = new THREE.WebGLRenderer( {antialias:true} );

        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild( renderer.domElement );

        var light = new THREE.PointLight(0xffffff);
        light.position.set(10,25,10);
        scene.add(light);

        var sphereGeometry = new THREE.SphereGeometry( 2, 32, 16 );
        var sphereMaterial = new THREE.MeshLambertMaterial( {color: 0x888888} );
        var sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
        sphere.position.set(0, 2, 0);
        sphere.name = "Sphere";
        scene.add(sphere);

        var scene2 = scene.clone();
        var camera2 = camera.clone();

        // now set up the objects in scene2
        var sphere2 = scene2.getObjectByName("Sphere");
        sphere2.material.transparent = true;
        sphere2.material.opacity = 0.5;
        sphere2.material.color = 0xff0000;
        scene2.add(sphere2);

        var blackMaterial = new THREE.MeshBasicMaterial( {color: 0x000000} );
        var blackSphere = new THREE.Mesh(sphereGeometry.clone(), blackMaterial);
        blackSphere.position.set(0, 2, 0);
        scene2.add(blackSphere);

        var renderTargetParameters = {
            minFilter: THREE.LinearFilter,
            magFilter: THREE.LinearFilter,
            format: THREE.RGBFormat,
            stencilBuffer: false
        };

        var renderTarget = new THREE.WebGLRenderTarget( window.innerWidth, window.innerHeight, renderTargetParameters );
        blurComposer = new THREE.EffectComposer( renderer, renderTarget );

        // prepare the secondary render's passes
        var render2Pass = new THREE.RenderPass( scene2, camera2 );
        blurComposer.addPass( render2Pass );

        // special effects to be applied to secondary render:
        var effectHorizBlur = new THREE.ShaderPass( THREE.HorizontalBlurShader );
        var effectVertiBlur = new THREE.ShaderPass( THREE.VerticalBlurShader );
        effectHorizBlur.uniforms[ "h" ].value = 2 / window.innerWidth;
        effectVertiBlur.uniforms[ "v" ].value = 2 / window.innerHeight;
        blurComposer.addPass( effectHorizBlur );
        blurComposer.addPass( effectVertiBlur );

        finalComposer = new THREE.EffectComposer( renderer, renderTarget );

        // prepare the final render's passes
        var renderModel = new THREE.RenderPass( scene, camera );
        finalComposer.addPass( renderModel );

        var effectBlend = new THREE.ShaderPass( THREE.AdditiveBlendShader, "tDiffuse1" );
        effectBlend.uniforms[ 'tDiffuse2' ].value = blurComposer.renderTarget2;
        effectBlend.renderToScreen = true;
        finalComposer.addPass( effectBlend );
    }

    /**
     * Animate the scene and call rendering.
     */
    function animateScene() {

        // Tell the browser to call this function when page is visible
        requestAnimationFrame(animateScene);

        blurComposer.render();
        finalComposer.render();
    }

</script>
</body>
</html>