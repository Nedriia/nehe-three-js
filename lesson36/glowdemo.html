<!DOCTYPE html>
<html lang="en">
<head>
    <title>Glow Demo</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1"/>

    <script src="../js/three.js" type="text/javascript"></script>
    <script src="../js/shaders/CopyShader.js" type="text/javascript"></script>
    <script src="../js/shaders/AdditiveBlendShader.js"></script>
    <script src="../js/shaders/HorizontalBlurShader.js"></script>
    <script src="../js/shaders/VerticalBlurShader.js"></script>
    <script src="../js/postprocess/EffectComposer.js" type="text/javascript"></script>
    <script src="../js/postprocess/ShaderPass.js" type="text/javascript"></script>
    <script src="../js/postprocess/RenderPass.js" type="text/javascript"></script>
    <script src="../js/postprocess/TexturePass.js" type="text/javascript"></script>
    <script src="../js/postprocess/MaskPass.js" type="text/javascript"></script>
    <script src="../js/postprocess/ClearPass.js" type="text/javascript"></script>
    <script src="../js/OrbitControls-Touch-Ortho.js" type="text/javascript"></script>
</head>
<body>
<script>
    var composer;
    var controls;
    var renderer;
    var clock;
    var mask;

    // then initialize our demo's stuff
    initializeDemo();

    // Animate the scene
    animateScene();

    /**
     * Initialize the Demo.
     */
    function initializeDemo() {
        renderer = new THREE.WebGLRenderer( {antialias:true} );

        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild( renderer.domElement );

        renderer.setClearColor(new THREE.Color( 0xcccccc ), 1);
        renderer.autoClear = false;

        clock = new THREE.Clock();

        var scene = new THREE.Scene();

        var camera = new THREE.PerspectiveCamera( 45, window.innerWidth/window.innerHeight, 0.1, 10000);
        scene.add(camera);
        camera.position.set(10,10,20);
        camera.lookAt(scene.position);

        controls = new THREE.OrbitControls( camera, renderer.domElement );

        var light = new THREE.DirectionalLight(0xffffff, 0.5);
        light.position.set(20,25,10);
        scene.add(light);

        var ambiLight = new THREE.AmbientLight(0xcccccc);
        scene.add(ambiLight);

        var maskScene = new THREE.Scene();

        var maskCamera = new THREE.PerspectiveCamera( 45, window.innerWidth/window.innerHeight, 0.1, 10000);
        maskScene.add(maskCamera);
        maskCamera.position.set(10,10,20);
        maskCamera.lookAt(maskScene.position);

        //var maskLight = new THREE.PointLight(0xffffff);
        //maskLight.position.set(10,25,10);
        //maskScene.add(maskLight);

        var haloScene = new THREE.Scene();

        var haloCamera = new THREE.PerspectiveCamera( 45, window.innerWidth/window.innerHeight, 0.1, 10000);
        haloScene.add(haloCamera);
        haloCamera.position.set(10,10,20);
        haloCamera.lookAt(haloScene.position);

        var haloLight = new THREE.DirectionalLight(0xffffff,0.5);
        haloLight.position.set(10,25,10);
        haloScene.add(haloLight);

        var haloGeom = new THREE.SphereGeometry( 4, 32, 16 );
        var haloMat= new THREE.MeshLambertMaterial( {color: 0xffff00, transparent:true, opacity:0.15} );
        var halo = new THREE.Mesh(haloGeom, haloMat);
        halo.position.set(0, 0, 0);
        haloScene.add(halo);

        mask = new THREE.Mesh(new THREE.SphereGeometry( 3, 32, 16 ));
        mask.position.set(0, 0, 0);
        maskScene.add(mask);

        var moonGeom = new THREE.SphereGeometry( 2, 32, 16 );
        var textureLoader = new THREE.TextureLoader();
        var moonMat = new THREE.MeshStandardMaterial( { color: 0xffffff });

        textureLoader.load( "images/moon.jpg", function( texture ) {
            moonMat.map = texture;
            moonMat.needsUpdate = true;
            var moon = new THREE.Mesh(moonGeom, moonMat);
            moon.position.set(0, 0, 0);
            scene.add(moon);
        });

        var clearPass = new THREE.ClearPass();

        var haloPass = new THREE.RenderPass(haloScene, haloCamera);

        var maskPass = new THREE.MaskPass(maskScene, maskCamera);
        //maskPass.inverse = true;

        var clearMaskPass = new THREE.ClearMaskPass();

        var renderPass = new THREE.RenderPass(scene, camera);
        renderPass.clear = false;

        var copyPass = new THREE.ShaderPass(THREE.CopyShader);
        copyPass.renderToScreen = true;

        var texture = new THREE.TextureLoader().load( 'images/moon.jpg' );
        var texturePass = new THREE.TexturePass( texture );

        var parameters = {
            minFilter: THREE.LinearFilter,
            magFilter: THREE.LinearFilter,
            format: THREE.RGBFormat,
            stencilBuffer: true
        };

        var renderTarget = new THREE.WebGLRenderTarget( window.innerWidth, window.innerHeight, parameters );

        composer = new THREE.EffectComposer(renderer, renderTarget);
        //composer.renderTarget1.stencilBuffer = true;
        //composer.renderTarget2.stencilBuffer = true;

        composer.addPass( clearPass );
        composer.addPass( maskPass );
        composer.addPass( texturePass );
        composer.addPass( clearMaskPass );
        composer.addPass( renderPass );
        composer.addPass( copyPass );
    }

    /**
     * Animate the scene and call rendering.
     */
    function animateScene() {

        var delta = clock.getDelta();
        controls.update(delta);

        var time = performance.now() * 0.001;

        mask.position.x = Math.cos( time ) * 2;
        mask.position.y = Math.sin( time / 1.5 ) * 2;

        renderer.clear();
        composer.render(delta);

        requestAnimationFrame(animateScene);
    }

</script>
</body>
</html>